<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Language IDE</title>
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #2c3e50; --danger-color: #e74c3c;
            --success-color: #27ae60; --warning-color: #f39c12; --info-color: #8e44ad;
            --dark-text: #34495e; --light-text: #ecf0f1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; flex-direction: column; color: var(--dark-text); }
        .ide-container { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 15px; margin: 20px; flex: 1; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 15px 20px; }
        .header h1 { font-size: 24px; font-weight: 300; }
        .header .logo { font-weight: bold; color: var(--primary-color); }
        .toolbar { background: #fdfdfd; padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-bottom: 1px solid #dee2e6; }
        .btn { background: linear-gradient(135deg, var(--primary-color), #2980b9); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn.success { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
        .btn.danger { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        .btn.warning { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
        .main-content { display: flex; flex: 1; min-height: 0; }
        .left-panel { width: 55%; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        .right-panel { width: 45%; display: flex; flex-direction: column; }
        .panel-header { background: #f8f9fa; padding: 10px 15px; font-weight: 600; color: var(--secondary-color); border-bottom: 1px solid #dee2e6; }
        #editor { width: 100%; height: 100%; flex: 1; font-family: 'Courier New', monospace; font-size: 16px; padding: 15px; border: none; outline: none; resize: none; background: var(--secondary-color); color: var(--light-text); line-height: 1.5; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6;}
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: #6c757d; font-weight: 500;}
        .tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { flex: 1; background: white; font-family: 'Courier New', monospace; font-size: 14px; overflow-y: auto; position: relative;}
        .output-area { padding: 15px; height: 100%; overflow-y: auto; white-space: pre-wrap; }
        .output-area .error { color: var(--danger-color); }
        .output-area .success { color: var(--success-color); }
        .output-area .info { color: var(--info-color); font-weight: bold; }
        .input-prompt { background: var(--primary-color); color: white; padding: 10px; border-radius: 5px; margin: 10px; display: none; align-items: center; gap: 10px; }
        .input-prompt input { flex: 1; padding: 5px 10px; border: none; border-radius: 3px; outline: none; color: #333; }
        .examples-dropdown { position: relative; }
        .examples-menu { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #dee2e6; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; display: none; }
        .examples-menu.show { display: block; }
        .example-item { padding: 10px 15px; cursor: pointer; transition: background 0.3s ease; }
        .example-item:hover { background: #f8f9fa; }
        .status-bar { background: var(--secondary-color); color: white; padding: 8px 20px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="ide-container">
        <div class="header"><h1><span class="logo">Simple</span> Language IDE</h1></div>

        <div class="toolbar">
            <button class="btn success" onclick="execute()" title="Executa o c√≥digo do editor (Simple ou SML)">‚ñ∂Ô∏è Executar</button>
            <button class="btn warning" onclick="stopExecution()" id="stopBtn" disabled>‚èπÔ∏è Parar</button>
            <div class="examples-dropdown">
                <button class="btn" onclick="toggleExamples()">üìÅ Exemplos</button>
                <div class="examples-menu" id="examplesMenu"></div>
            </div>
            <button class="btn danger" onclick="clearAll()">üóëÔ∏è Limpar Tudo</button>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="panel-header">Editor de C√≥digo (Simple ou SML)</div>
                <div id="editor" class="code-editor"></div>
            </div>

            <div class="right-panel">
                <div class="tabs">
                    <div class="tab active" data-tab="output">Sa√≠da Simple</div>
                    <div class="tab" data-tab="sml_output">Sa√≠da SML</div>
                    <div class="tab" data-tab="sml">SML Traduzido</div>
                    <div class="tab" data-tab="ast">AST</div>
                    <div class="tab" data-tab="tokens">Tokens</div>
                </div>

                <div class="tab-content">
                    <div class="input-prompt" id="inputPrompt"><span id="promptText">? </span><input type="text" id="inputField"><button class="btn" onclick="sendInput()">Enviar</button></div>
                    <div id="output" class="output-area"></div>
                    <div id="sml_output" class="output-area" style="display: none;"><div id="smlOutputContent"></div></div>
                    <div id="sml" class="output-area" style="display: none;"></div>
                    <div id="ast" class="output-area" style="display: none; font-size: 12px;"></div>
                    <div id="tokens" class="output-area" style="display: none;"></div>
                </div>
            </div>
        </div>
        <div class="status-bar" id="statusMessage">Pronto.</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
    <script>
        let currentWebSocket = null;
        let isExecuting = false;
        let editor;

        document.addEventListener('DOMContentLoaded', () => {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: '10 rem Soma dois n√∫meros\n20 input a\n30 input b\n40 let c = a + b\n50 print c\n60 end',
                    language: 'plaintext',
                    theme: 'vs-dark',
                    automaticLayout: true
                });
            });
            loadExamples();
            setupTabs();
        });

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.output-area').forEach(c => c.style.display = 'none');
                    document.getElementById(e.target.dataset.tab).style.display = 'block';
                });
            });
        }
        
        function displayInTab(tabId, content, type = '') {
            const container = document.getElementById(tabId);
            const contentArea = tabId === 'sml_output' ? document.getElementById('smlOutputContent') : container;
            const div = document.createElement('div');
            if (type) div.className = type;
            div.textContent = content;
            contentArea.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function clearTabs(...tabIds) {
            tabIds.forEach(id => {
                const el = id === 'sml_output' ? document.getElementById('smlOutputContent') : document.getElementById(id);
                if(el) el.innerHTML = '';
            });
        }
        
        function clearAll() {
            if(editor) editor.setValue('');
            clearTabs('output', 'sml_output', 'sml', 'ast', 'tokens');
            updateStatus('Pronto.');
        }

        async function loadExamples() {
            const response = await fetch('/api/examples');
            const examples = await response.json();
            const menu = document.getElementById('examplesMenu');
            menu.innerHTML = '';
            for (const [key, ex] of Object.entries(examples)) {
                const item = document.createElement('div');
                item.className = 'example-item';
                item.textContent = ex.name;
                item.onclick = () => { if(editor) editor.setValue(ex.code); toggleExamples(); };
                menu.appendChild(item);
            }
        }

        function toggleExamples() { document.getElementById('examplesMenu').classList.toggle('show'); }
        function updateStatus(message) { document.getElementById('statusMessage').textContent = message; }

        async function compileAndShow(code) {
            clearTabs('ast', 'tokens');
            const response = await fetch('/api/compile', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code }) });
            const result = await response.json();
            if(result.success) {
                document.getElementById('ast').textContent = JSON.stringify(result.ast, null, 2);
                document.getElementById('tokens').textContent = result.tokens.map(t => `${t.type}(${t.value || ''}) @ ${t.line}:${t.column}`).join('\n');
            } else {
                displayInTab('ast', 'Erro de compila√ß√£o:\n' + result.errors.join('\n'), 'error');
            }
        }

        async function execute() {
            const code = editor.getValue();
            if (!code.trim()) { alert('Editor de c√≥digo est√° vazio.'); return; }

            if (currentWebSocket) currentWebSocket.close();
            
            updateStatus('Iniciando execu√ß√£o...');
            clearTabs('output', 'sml_output', 'sml', 'ast', 'tokens');
            isExecuting = true;
            document.getElementById('stopBtn').disabled = false;

            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            currentWebSocket = new WebSocket(`${protocol}//${location.host}/api/execute-interactive`);

            currentWebSocket.onopen = () => {
                updateStatus('Conectado. Enviando c√≥digo...');
                currentWebSocket.send(JSON.stringify({ code }));
            };

            currentWebSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'output':
                        displayInTab('output', data.data); break;
                    case 'sml_translation':
                        document.getElementById('sml').textContent = data.sml_code.join('\n');
                        compileAndShow(code); break;
                    case 'sml_execution_started':
                        displayInTab('sml_output', '--- Iniciando Execu√ß√£o SML ---', 'info'); break;
                    case 'sml_output':
                        displayInTab('sml_output', data.data, 'success'); break;
                    case 'input_request':
                        showInputPrompt(data.message, data.variable); break;
                    case 'execution_finished':
                        const statusMsg = data.success ? 'Execu√ß√£o conclu√≠da.' : 'Erro de execu√ß√£o.';
                        const statusClass = data.success ? 'success' : 'error';
                        const finalMsg = `\n${data.success ? '‚úÖ' : '‚ùå'} ${statusMsg}`;
                        displayInTab('output', finalMsg, statusClass);
                        displayInTab('sml_output', finalMsg, statusClass);
                        if (!data.success) {
                            displayInTab('output', data.error, 'error');
                            displayInTab('sml_output', `Falha: ${data.error}`, 'error');
                        }
                        updateStatus(statusMsg);
                        stopExecution();
                        break;
                    case 'error':
                        displayInTab('output', '\n‚ùå ERRO GERAL: ' + data.message, 'error');
                        updateStatus('Erro na conex√£o.');
                        stopExecution();
                        break;
                }
            };
            
            currentWebSocket.onclose = () => {
                if (isExecuting) {
                    updateStatus('Execu√ß√£o interrompida.');
                    displayInTab('output', '\nüîå Conex√£o fechada.', 'error');
                    stopExecution();
                }
            };
        }

        function stopExecution() {
            if (currentWebSocket) {
                currentWebSocket.close();
                currentWebSocket = null;
            }
            isExecuting = false;
            document.getElementById('stopBtn').disabled = true;
            hideInputPrompt();
            if (document.getElementById('statusMessage').textContent.includes('Executando')) {
                 updateStatus('Execu√ß√£o interrompida pelo usu√°rio.');
            }
        }
        
        function showInputPrompt(message, variable) {
            const prompt = document.getElementById('inputPrompt');
            prompt.style.display = 'flex';
            const inputField = document.getElementById('inputField');
            inputField.value = '';
            inputField.placeholder = `Valor para '${variable || 'SML'}'`;
            inputField.focus();
            document.getElementById('promptText').textContent = message || '?';
            inputField.onkeydown = (e) => { if (e.key === 'Enter') sendInput(); };
        }

        function hideInputPrompt() { document.getElementById('inputPrompt').style.display = 'none'; }

        function sendInput() {
            const inputField = document.getElementById('inputField');
            const value = inputField.value.trim();
            if (!/^-?\d+$/.test(value)) { alert('Por favor, digite um n√∫mero inteiro.'); return; }
            if (currentWebSocket) currentWebSocket.send(JSON.stringify({ type: 'input', value }));
            // Mostra o input na aba de sa√≠da ativa no momento
            const activeTabId = document.querySelector('.tab.active').dataset.tab;
            displayInTab(activeTabId, `> ${value}`);
            hideInputPrompt();
        }
    </script>
</body>
</html>